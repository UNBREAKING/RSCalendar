'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Tab = undefined;

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _objectWithoutProperties2 = require('babel-runtime/helpers/objectWithoutProperties');

var _objectWithoutProperties3 = _interopRequireDefault(_objectWithoutProperties2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _classnames = require('classnames');

var _classnames2 = _interopRequireDefault(_classnames);

var _util = require('./util');

var _DropdownButton = require('./DropdownButton');

var _DropdownButton2 = _interopRequireDefault(_DropdownButton);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 *
 */
var TabContent = function TabContent(props) {
  var className = props.className,
      active = props.active,
      children = props.children,
      pprops = (0, _objectWithoutProperties3.default)(props, ['className', 'active', 'children']);

  var tabClassNames = (0, _classnames2.default)(className, 'slds-tabs__content', 'slds-' + (active ? 'show' : 'hide'));
  return _react2.default.createElement(
    'div',
    (0, _extends3.default)({ className: tabClassNames, role: 'tabpanel' }, pprops),
    children
  );
};

TabContent.propTypes = {
  className: _react.PropTypes.string,
  active: _react.PropTypes.bool,
  children: _react.PropTypes.node
};

/**
 *
 */
var TabMenu = function TabMenu(props) {
  var _props$icon = props.icon,
      icon = _props$icon === undefined ? 'down' : _props$icon,
      children = props.children,
      pprops = (0, _objectWithoutProperties3.default)(props, ['icon', 'children']);

  return _react2.default.createElement(
    _DropdownButton2.default,
    (0, _extends3.default)({
      className: 'react-slds-tab-menu',
      icon: icon,
      type: 'icon-bare',
      iconSize: 'small',
      nubbinTop: true
    }, pprops),
    children
  );
};

TabMenu.propTypes = {
  icon: _react.PropTypes.string,
  children: _react.PropTypes.node
};

var DefaultTabItemRenderer = function DefaultTabItemRenderer(props) {
  return _react2.default.Children.only(props.children);
};

DefaultTabItemRenderer.propTypes = {
  children: _react.PropTypes.node
};

/**
 *
 */
var TabItem = function TabItem(props) {
  var type = props.type,
      title = props.title,
      activeKey = props.activeKey,
      eventKey = props.eventKey,
      activeTabRef = props.activeTabRef,
      menu = props.menu,
      menuIcon = props.menuIcon,
      onTabClick = props.onTabClick,
      onTabKeyDown = props.onTabKeyDown;
  var menuItems = props.menuItems;

  menuItems = menu ? menu.props.children : menuItems;
  var menuProps = menu ? menu.props : {};
  var isActive = eventKey === activeKey;
  var tabItemClassName = (0, _classnames2.default)({ 'slds-tabs__item': !!menuItems }, 'slds-tabs--' + type + '__item', 'slds-text-heading---label', { 'slds-active': isActive }, { 'react-slds-tab-with-menu': menu || menuItems });
  var tabLinkClassName = 'slds-tabs--' + type + '__link';
  var _props$tabItemRendere = props.tabItemRenderer,
      TabItemRenderer = _props$tabItemRendere === undefined ? DefaultTabItemRenderer : _props$tabItemRendere,
      pprops = (0, _objectWithoutProperties3.default)(props, ['tabItemRenderer']);

  return _react2.default.createElement(
    'li',
    { className: tabItemClassName, role: 'presentation' },
    _react2.default.createElement(
      TabItemRenderer,
      pprops,
      _react2.default.createElement(
        'span',
        { className: 'react-slds-tab-item-content' },
        _react2.default.createElement(
          'a',
          {
            className: tabLinkClassName,
            role: 'tab',
            ref: isActive ? activeTabRef : undefined,
            tabIndex: isActive ? 0 : -1,
            'aria-selected': isActive,
            onClick: function onClick() {
              return onTabClick(eventKey);
            },
            onKeyDown: function onKeyDown(e) {
              return onTabKeyDown(eventKey, e);
            }
          },
          title
        ),
        menuItems ? _react2.default.createElement(
          TabMenu,
          (0, _extends3.default)({ icon: menuIcon }, menuProps),
          menuItems
        ) : undefined
      )
    )
  );
};

TabItem.propTypes = {
  type: _react.PropTypes.string,
  activeTabRef: _react.PropTypes.func,
  title: _react.PropTypes.string,
  menu: _react.PropTypes.element,
  menuItems: _react.PropTypes.arrayOf(_react.PropTypes.element),
  menuIcon: _react.PropTypes.string,
  eventKey: _react.PropTypes.oneOfType([_react.PropTypes.string, _react.PropTypes.number]),
  activeKey: _react.PropTypes.oneOfType([_react.PropTypes.string, _react.PropTypes.number]),
  tabItemRenderer: _react.PropTypes.func,
  onTabClick: _react.PropTypes.func,
  onTabKeyDown: _react.PropTypes.func
};

/**
 *
 */
var TabNav = function TabNav(props) {
  var type = props.type,
      tabs = props.tabs,
      activeKey = props.activeKey,
      activeTabRef = props.activeTabRef,
      onTabClick = props.onTabClick,
      onTabKeyDown = props.onTabKeyDown;

  var tabNavClassName = 'slds-tabs--' + type + '__nav';
  return _react2.default.createElement(
    'ul',
    { className: tabNavClassName, role: 'tablist' },
    _react2.default.Children.map(tabs, function (tab) {
      return _react2.default.createElement(TabItem, (0, _extends3.default)({}, tab.props, {
        type: type,
        activeKey: activeKey,
        activeTabRef: activeTabRef,
        onTabClick: onTabClick,
        onTabKeyDown: onTabKeyDown
      }));
    })
  );
};

TabNav.propTypes = {
  type: _react.PropTypes.string,
  activeKey: _react.PropTypes.oneOfType([_react.PropTypes.string, _react.PropTypes.number]),
  activeTabRef: _react.PropTypes.func,
  tabs: _react.PropTypes.node,
  onTabClick: _react.PropTypes.func,
  onTabKeyDown: _react.PropTypes.func
};

/**
 *
 */
var Tab = exports.Tab = function Tab(props) {
  var className = props.className,
      eventKey = props.eventKey,
      activeKey = props.activeKey,
      children = props.children;

  return _react2.default.createElement(
    TabContent,
    { className: className, active: eventKey === activeKey },
    children
  );
};

Tab.propTypes = {
  className: _react.PropTypes.string,
  title: _react.PropTypes.string,
  eventKey: _react.PropTypes.oneOfType([_react.PropTypes.string, _react.PropTypes.number]),
  menu: _react.PropTypes.element,
  menuItems: _react.PropTypes.arrayOf(_react.PropTypes.element),
  menuIcon: _react.PropTypes.string,
  activeKey: _react.PropTypes.oneOfType([_react.PropTypes.string, _react.PropTypes.number]),
  children: _react.PropTypes.node,
  tabItemRenderer: _react.PropTypes.func
};

/**
 *
 */

var Tabs = function (_Component) {
  (0, _inherits3.default)(Tabs, _Component);

  function Tabs() {
    (0, _classCallCheck3.default)(this, Tabs);

    var _this = (0, _possibleConstructorReturn3.default)(this, (Tabs.__proto__ || (0, _getPrototypeOf2.default)(Tabs)).call(this));

    _this.onTabClick = function (tabKey) {
      if (_this.props.onSelect) {
        _this.props.onSelect(tabKey);
      }
      // Uncontrolled
      _this.setState({ activeKey: tabKey, focusTab: true });
    };

    _this.onTabKeyDown = function (tabKey, e) {
      if (e.keyCode === 37 || e.keyCode === 39) {
        (function () {
          // left/right cursor key
          var idx = 0;
          var tabKeys = [];
          _react2.default.Children.forEach(_this.props.children, function (tab, i) {
            tabKeys.push(tab.props.eventKey);
            if (tabKey === tab.props.eventKey) {
              idx = i;
            }
          });
          var dir = e.keyCode === 37 ? -1 : 1;
          var activeIdx = (idx + dir + tabKeys.length) % tabKeys.length;
          var activeKey = tabKeys[activeIdx];
          _this.onTabClick(activeKey);
          e.preventDefault();
          e.stopPropagation();
        })();
      }
    };

    _this.state = {};
    (0, _util.registerStyle)('tab-menu', [['.slds-tabs__item.react-slds-tab-with-menu', '{ position: relative !important; overflow: visible !important; }'], ['.slds-tabs__item.react-slds-tab-with-menu > .react-slds-tab-item-content', '{ overflow: hidden }'], ['.slds-tabs__item.react-slds-tab-with-menu > .react-slds-tab-item-content > a', '{ padding-right: 2rem; }'], ['.react-slds-tab-menu', '{ position: absolute; top: 0; right: 0; visibility: hidden }'], ['.react-slds-tab-menu button', '{ height: 2.5rem; line-height: 2rem; width: 2rem; }'], ['.slds-tabs__item.slds-active .react-slds-tab-menu', '.slds-tabs__item:hover .react-slds-tab-menu', '{ visibility: visible }']]);
    return _this;
  }

  (0, _createClass3.default)(Tabs, [{
    key: 'componentDidUpdate',
    value: function componentDidUpdate() {
      if (this.state.focusTab) {
        var el = this.activeTab;
        if (el) {
          el.focus();
        }
        /* eslint-disable react/no-did-update-set-state */
        this.setState({ focusTab: false });
      }
    }
  }, {
    key: 'render',
    value: function render() {
      var _this2 = this;

      var _props = this.props,
          className = _props.className,
          children = _props.children;

      var type = this.props.type === 'scoped' ? 'scoped' : 'default';
      var tabsClassNames = (0, _classnames2.default)(className, 'slds-tabs--' + type);
      var activeKey = typeof this.props.activeKey !== 'undefined' ? this.props.activeKey : typeof this.state.activeKey !== 'undefined' ? this.state.activeKey : this.props.defaultActiveKey;
      return _react2.default.createElement(
        'div',
        { className: tabsClassNames },
        _react2.default.createElement(TabNav, {
          type: type,
          activeKey: activeKey,
          activeTabRef: function activeTabRef(node) {
            _this2.activeTab = node;
          },
          tabs: children,
          onTabClick: this.onTabClick,
          onTabKeyDown: this.onTabKeyDown
        }),
        _react2.default.Children.map(children, function (tab) {
          return _react2.default.cloneElement(tab, { activeKey: activeKey });
        })
      );
    }
  }]);
  return Tabs;
}(_react.Component);

exports.default = Tabs;


var TAB_TYPES = ['default', 'scoped'];

Tabs.propTypes = {
  className: _react.PropTypes.string,
  type: _react.PropTypes.oneOf(TAB_TYPES),
  onSelect: _react.PropTypes.func,
  children: _react.PropTypes.node,
  defaultActiveKey: _react.PropTypes.oneOfType([_react.PropTypes.string, _react.PropTypes.number]),
  activeKey: _react.PropTypes.oneOfType([_react.PropTypes.string, _react.PropTypes.number])
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JpcHRzL1RhYnMuanMiXSwibmFtZXMiOlsiVGFiQ29udGVudCIsInByb3BzIiwiY2xhc3NOYW1lIiwiYWN0aXZlIiwiY2hpbGRyZW4iLCJwcHJvcHMiLCJ0YWJDbGFzc05hbWVzIiwicHJvcFR5cGVzIiwic3RyaW5nIiwiYm9vbCIsIm5vZGUiLCJUYWJNZW51IiwiaWNvbiIsIkRlZmF1bHRUYWJJdGVtUmVuZGVyZXIiLCJDaGlsZHJlbiIsIm9ubHkiLCJUYWJJdGVtIiwidHlwZSIsInRpdGxlIiwiYWN0aXZlS2V5IiwiZXZlbnRLZXkiLCJhY3RpdmVUYWJSZWYiLCJtZW51IiwibWVudUljb24iLCJvblRhYkNsaWNrIiwib25UYWJLZXlEb3duIiwibWVudUl0ZW1zIiwibWVudVByb3BzIiwiaXNBY3RpdmUiLCJ0YWJJdGVtQ2xhc3NOYW1lIiwidGFiTGlua0NsYXNzTmFtZSIsInRhYkl0ZW1SZW5kZXJlciIsIlRhYkl0ZW1SZW5kZXJlciIsInVuZGVmaW5lZCIsImUiLCJmdW5jIiwiZWxlbWVudCIsImFycmF5T2YiLCJvbmVPZlR5cGUiLCJudW1iZXIiLCJUYWJOYXYiLCJ0YWJzIiwidGFiTmF2Q2xhc3NOYW1lIiwibWFwIiwidGFiIiwiVGFiIiwiVGFicyIsInRhYktleSIsIm9uU2VsZWN0Iiwic2V0U3RhdGUiLCJmb2N1c1RhYiIsImtleUNvZGUiLCJpZHgiLCJ0YWJLZXlzIiwiZm9yRWFjaCIsImkiLCJwdXNoIiwiZGlyIiwiYWN0aXZlSWR4IiwibGVuZ3RoIiwicHJldmVudERlZmF1bHQiLCJzdG9wUHJvcGFnYXRpb24iLCJzdGF0ZSIsImVsIiwiYWN0aXZlVGFiIiwiZm9jdXMiLCJ0YWJzQ2xhc3NOYW1lcyIsImRlZmF1bHRBY3RpdmVLZXkiLCJjbG9uZUVsZW1lbnQiLCJUQUJfVFlQRVMiLCJvbmVPZiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7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SGI7QUFJQSxhQUNFO0FBQUE7QUFBQSxVQUFLLFdBQVlELGNBQWpCO0FBQ0Usc0NBQUMsTUFBRDtBQUNFLGdCQUFPakQsSUFEVDtBQUVFLHFCQUFZRSxTQUZkO0FBR0Usd0JBQWUsc0JBQUNULElBQUQsRUFBVTtBQUFFLG1CQUFLc0QsU0FBTCxHQUFpQnRELElBQWpCO0FBQXdCLFdBSHJEO0FBSUUsZ0JBQU9OLFFBSlQ7QUFLRSxzQkFBYSxLQUFLb0IsVUFMcEI7QUFNRSx3QkFBZSxLQUFLQztBQU50QixVQURGO0FBU0ksd0JBQU1YLFFBQU4sQ0FBZTZCLEdBQWYsQ0FBbUJ2QyxRQUFuQixFQUE2QjtBQUFBLGlCQUFPLGdCQUFNZ0UsWUFBTixDQUFtQnhCLEdBQW5CLEVBQXdCLEVBQUV6QixvQkFBRixFQUF4QixDQUFQO0FBQUEsU0FBN0I7QUFUSixPQURGO0FBYUQ7Ozs7O2tCQTdGa0IyQixJOzs7QUFnR3JCLElBQU11QixZQUFZLENBQUMsU0FBRCxFQUFZLFFBQVosQ0FBbEI7O0FBRUF2QixLQUFLdkMsU0FBTCxHQUFpQjtBQUNmTCxhQUFXLGlCQUFVTSxNQUROO0FBRWZTLFFBQU0saUJBQVVxRCxLQUFWLENBQWdCRCxTQUFoQixDQUZTO0FBR2ZyQixZQUFVLGlCQUFVYixJQUhMO0FBSWYvQixZQUFVLGlCQUFVTSxJQUpMO0FBS2Z5RCxvQkFBa0IsaUJBQVU3QixTQUFWLENBQW9CLENBQ3BDLGlCQUFVOUIsTUFEMEIsRUFFcEMsaUJBQVUrQixNQUYwQixDQUFwQixDQUxIO0FBU2ZwQixhQUFXLGlCQUFVbUIsU0FBVixDQUFvQixDQUM3QixpQkFBVTlCLE1BRG1CLEVBRTdCLGlCQUFVK0IsTUFGbUIsQ0FBcEI7QUFUSSxDQUFqQiIsImZpbGUiOiJUYWJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IFByb3BUeXBlcywgQ29tcG9uZW50IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IGNsYXNzbmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XG5pbXBvcnQgeyByZWdpc3RlclN0eWxlIH0gZnJvbSAnLi91dGlsJztcbmltcG9ydCBEcm9wZG93bkJ1dHRvbiBmcm9tICcuL0Ryb3Bkb3duQnV0dG9uJztcblxuLyoqXG4gKlxuICovXG5jb25zdCBUYWJDb250ZW50ID0gKHByb3BzKSA9PiB7XG4gIGNvbnN0IHsgY2xhc3NOYW1lLCBhY3RpdmUsIGNoaWxkcmVuLCAuLi5wcHJvcHMgfSA9IHByb3BzO1xuICBjb25zdCB0YWJDbGFzc05hbWVzID0gY2xhc3NuYW1lcyhcbiAgICBjbGFzc05hbWUsXG4gICAgJ3NsZHMtdGFic19fY29udGVudCcsXG4gICAgYHNsZHMtJHthY3RpdmUgPyAnc2hvdycgOiAnaGlkZSd9YFxuICApO1xuICByZXR1cm4gKFxuICAgIDxkaXYgY2xhc3NOYW1lPXsgdGFiQ2xhc3NOYW1lcyB9IHJvbGU9J3RhYnBhbmVsJyB7IC4uLnBwcm9wcyB9PlxuICAgICAgeyBjaGlsZHJlbiB9XG4gICAgPC9kaXY+XG4gICk7XG59O1xuXG5UYWJDb250ZW50LnByb3BUeXBlcyA9IHtcbiAgY2xhc3NOYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICBhY3RpdmU6IFByb3BUeXBlcy5ib29sLFxuICBjaGlsZHJlbjogUHJvcFR5cGVzLm5vZGUsXG59O1xuXG4vKipcbiAqXG4gKi9cbmNvbnN0IFRhYk1lbnUgPSAocHJvcHMpID0+IHtcbiAgY29uc3QgeyBpY29uID0gJ2Rvd24nLCBjaGlsZHJlbiwgLi4ucHByb3BzIH0gPSBwcm9wcztcbiAgcmV0dXJuIChcbiAgICA8RHJvcGRvd25CdXR0b25cbiAgICAgIGNsYXNzTmFtZT0ncmVhY3Qtc2xkcy10YWItbWVudSdcbiAgICAgIGljb249eyBpY29uIH1cbiAgICAgIHR5cGU9J2ljb24tYmFyZSdcbiAgICAgIGljb25TaXplPSdzbWFsbCdcbiAgICAgIG51YmJpblRvcFxuICAgICAgeyAuLi5wcHJvcHMgfVxuICAgID5cbiAgICAgIHsgY2hpbGRyZW4gfVxuICAgIDwvRHJvcGRvd25CdXR0b24+XG4gICk7XG59O1xuXG5UYWJNZW51LnByb3BUeXBlcyA9IHtcbiAgaWNvbjogUHJvcFR5cGVzLnN0cmluZyxcbiAgY2hpbGRyZW46IFByb3BUeXBlcy5ub2RlLFxufTtcblxuY29uc3QgRGVmYXVsdFRhYkl0ZW1SZW5kZXJlciA9IHByb3BzID0+IChcbiAgUmVhY3QuQ2hpbGRyZW4ub25seShwcm9wcy5jaGlsZHJlbilcbik7XG5cbkRlZmF1bHRUYWJJdGVtUmVuZGVyZXIucHJvcFR5cGVzID0ge1xuICBjaGlsZHJlbjogUHJvcFR5cGVzLm5vZGUsXG59O1xuXG5cbi8qKlxuICpcbiAqL1xuY29uc3QgVGFiSXRlbSA9IChwcm9wcykgPT4ge1xuICBjb25zdCB7XG4gICAgdHlwZSwgdGl0bGUsIGFjdGl2ZUtleSwgZXZlbnRLZXksIGFjdGl2ZVRhYlJlZixcbiAgICBtZW51LCBtZW51SWNvbixcbiAgICBvblRhYkNsaWNrLCBvblRhYktleURvd24sXG4gIH0gPSBwcm9wcztcbiAgbGV0IHsgbWVudUl0ZW1zIH0gPSBwcm9wcztcbiAgbWVudUl0ZW1zID0gbWVudSA/IG1lbnUucHJvcHMuY2hpbGRyZW4gOiBtZW51SXRlbXM7XG4gIGNvbnN0IG1lbnVQcm9wcyA9IG1lbnUgPyBtZW51LnByb3BzIDoge307XG4gIGNvbnN0IGlzQWN0aXZlID0gZXZlbnRLZXkgPT09IGFjdGl2ZUtleTtcbiAgY29uc3QgdGFiSXRlbUNsYXNzTmFtZSA9IGNsYXNzbmFtZXMoXG4gICAgeyAnc2xkcy10YWJzX19pdGVtJzogISFtZW51SXRlbXMgfSxcbiAgICBgc2xkcy10YWJzLS0ke3R5cGV9X19pdGVtYCxcbiAgICAnc2xkcy10ZXh0LWhlYWRpbmctLS1sYWJlbCcsXG4gICAgeyAnc2xkcy1hY3RpdmUnOiBpc0FjdGl2ZSB9LFxuICAgIHsgJ3JlYWN0LXNsZHMtdGFiLXdpdGgtbWVudSc6IG1lbnUgfHwgbWVudUl0ZW1zIH1cbiAgKTtcbiAgY29uc3QgdGFiTGlua0NsYXNzTmFtZSA9IGBzbGRzLXRhYnMtLSR7dHlwZX1fX2xpbmtgO1xuICBjb25zdCB7IHRhYkl0ZW1SZW5kZXJlcjogVGFiSXRlbVJlbmRlcmVyID0gRGVmYXVsdFRhYkl0ZW1SZW5kZXJlciwgLi4ucHByb3BzIH0gPSBwcm9wcztcbiAgcmV0dXJuIChcbiAgICA8bGkgY2xhc3NOYW1lPXsgdGFiSXRlbUNsYXNzTmFtZSB9IHJvbGU9J3ByZXNlbnRhdGlvbic+XG4gICAgICA8VGFiSXRlbVJlbmRlcmVyIHsgLi4ucHByb3BzIH0+XG4gICAgICAgIDxzcGFuIGNsYXNzTmFtZT0ncmVhY3Qtc2xkcy10YWItaXRlbS1jb250ZW50Jz5cbiAgICAgICAgICA8YVxuICAgICAgICAgICAgY2xhc3NOYW1lPXsgdGFiTGlua0NsYXNzTmFtZSB9XG4gICAgICAgICAgICByb2xlPSd0YWInXG4gICAgICAgICAgICByZWY9eyBpc0FjdGl2ZSA/IGFjdGl2ZVRhYlJlZiA6IHVuZGVmaW5lZCB9XG4gICAgICAgICAgICB0YWJJbmRleD17IGlzQWN0aXZlID8gMCA6IC0xIH1cbiAgICAgICAgICAgIGFyaWEtc2VsZWN0ZWQ9eyBpc0FjdGl2ZSB9XG4gICAgICAgICAgICBvbkNsaWNrPXsgKCkgPT4gb25UYWJDbGljayhldmVudEtleSkgfVxuICAgICAgICAgICAgb25LZXlEb3duPXsgZSA9PiBvblRhYktleURvd24oZXZlbnRLZXksIGUpIH1cbiAgICAgICAgICA+XG4gICAgICAgICAgICB7IHRpdGxlIH1cbiAgICAgICAgICA8L2E+XG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVudUl0ZW1zID9cbiAgICAgICAgICAgICAgPFRhYk1lbnUgaWNvbj17IG1lbnVJY29uIH0geyAuLi5tZW51UHJvcHMgfT57IG1lbnVJdGVtcyB9PC9UYWJNZW51PiA6XG4gICAgICAgICAgICAgIHVuZGVmaW5lZFxuICAgICAgICAgIH1cbiAgICAgICAgPC9zcGFuPlxuICAgICAgPC9UYWJJdGVtUmVuZGVyZXI+XG4gICAgPC9saT5cbiAgKTtcbn07XG5cblRhYkl0ZW0ucHJvcFR5cGVzID0ge1xuICB0eXBlOiBQcm9wVHlwZXMuc3RyaW5nLFxuICBhY3RpdmVUYWJSZWY6IFByb3BUeXBlcy5mdW5jLFxuICB0aXRsZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgbWVudTogUHJvcFR5cGVzLmVsZW1lbnQsXG4gIG1lbnVJdGVtczogUHJvcFR5cGVzLmFycmF5T2YoUHJvcFR5cGVzLmVsZW1lbnQpLFxuICBtZW51SWNvbjogUHJvcFR5cGVzLnN0cmluZyxcbiAgZXZlbnRLZXk6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1xuICAgIFByb3BUeXBlcy5zdHJpbmcsXG4gICAgUHJvcFR5cGVzLm51bWJlcixcbiAgXSksXG4gIGFjdGl2ZUtleTogUHJvcFR5cGVzLm9uZU9mVHlwZShbXG4gICAgUHJvcFR5cGVzLnN0cmluZyxcbiAgICBQcm9wVHlwZXMubnVtYmVyLFxuICBdKSxcbiAgdGFiSXRlbVJlbmRlcmVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgb25UYWJDbGljazogUHJvcFR5cGVzLmZ1bmMsXG4gIG9uVGFiS2V5RG93bjogUHJvcFR5cGVzLmZ1bmMsXG59O1xuXG4vKipcbiAqXG4gKi9cbmNvbnN0IFRhYk5hdiA9IChwcm9wcykgPT4ge1xuICBjb25zdCB7XG4gICAgdHlwZSwgdGFicywgYWN0aXZlS2V5LCBhY3RpdmVUYWJSZWYsXG4gICAgb25UYWJDbGljaywgb25UYWJLZXlEb3duLFxuICB9ID0gcHJvcHM7XG4gIGNvbnN0IHRhYk5hdkNsYXNzTmFtZSA9IGBzbGRzLXRhYnMtLSR7dHlwZX1fX25hdmA7XG4gIHJldHVybiAoXG4gICAgPHVsIGNsYXNzTmFtZT17IHRhYk5hdkNsYXNzTmFtZSB9IHJvbGU9J3RhYmxpc3QnPlxuICAgICAge1xuICAgICAgICBSZWFjdC5DaGlsZHJlbi5tYXAodGFicywgdGFiID0+IChcbiAgICAgICAgICA8VGFiSXRlbVxuICAgICAgICAgICAgeyAuLi50YWIucHJvcHMgfVxuICAgICAgICAgICAgdHlwZT17IHR5cGUgfVxuICAgICAgICAgICAgYWN0aXZlS2V5PXsgYWN0aXZlS2V5IH1cbiAgICAgICAgICAgIGFjdGl2ZVRhYlJlZj17IGFjdGl2ZVRhYlJlZiB9XG4gICAgICAgICAgICBvblRhYkNsaWNrPXsgb25UYWJDbGljayB9XG4gICAgICAgICAgICBvblRhYktleURvd249eyBvblRhYktleURvd24gfVxuICAgICAgICAgIC8+XG4gICAgICAgICkpXG4gICAgICB9XG4gICAgPC91bD5cbiAgKTtcbn07XG5cblRhYk5hdi5wcm9wVHlwZXMgPSB7XG4gIHR5cGU6IFByb3BUeXBlcy5zdHJpbmcsXG4gIGFjdGl2ZUtleTogUHJvcFR5cGVzLm9uZU9mVHlwZShbXG4gICAgUHJvcFR5cGVzLnN0cmluZyxcbiAgICBQcm9wVHlwZXMubnVtYmVyLFxuICBdKSxcbiAgYWN0aXZlVGFiUmVmOiBQcm9wVHlwZXMuZnVuYyxcbiAgdGFiczogUHJvcFR5cGVzLm5vZGUsXG4gIG9uVGFiQ2xpY2s6IFByb3BUeXBlcy5mdW5jLFxuICBvblRhYktleURvd246IFByb3BUeXBlcy5mdW5jLFxufTtcblxuLyoqXG4gKlxuICovXG5leHBvcnQgY29uc3QgVGFiID0gKHByb3BzKSA9PiB7XG4gIGNvbnN0IHsgY2xhc3NOYW1lLCBldmVudEtleSwgYWN0aXZlS2V5LCBjaGlsZHJlbiB9ID0gcHJvcHM7XG4gIHJldHVybiAoXG4gICAgPFRhYkNvbnRlbnQgY2xhc3NOYW1lPXsgY2xhc3NOYW1lIH0gYWN0aXZlPXsgZXZlbnRLZXkgPT09IGFjdGl2ZUtleSB9PlxuICAgICAgeyBjaGlsZHJlbiB9XG4gICAgPC9UYWJDb250ZW50PlxuICApO1xufTtcblxuVGFiLnByb3BUeXBlcyA9IHtcbiAgY2xhc3NOYW1lOiBQcm9wVHlwZXMuc3RyaW5nLFxuICB0aXRsZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgZXZlbnRLZXk6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1xuICAgIFByb3BUeXBlcy5zdHJpbmcsXG4gICAgUHJvcFR5cGVzLm51bWJlcixcbiAgXSksXG4gIG1lbnU6IFByb3BUeXBlcy5lbGVtZW50LFxuICBtZW51SXRlbXM6IFByb3BUeXBlcy5hcnJheU9mKFByb3BUeXBlcy5lbGVtZW50KSxcbiAgbWVudUljb246IFByb3BUeXBlcy5zdHJpbmcsXG4gIGFjdGl2ZUtleTogUHJvcFR5cGVzLm9uZU9mVHlwZShbXG4gICAgUHJvcFR5cGVzLnN0cmluZyxcbiAgICBQcm9wVHlwZXMubnVtYmVyLFxuICBdKSxcbiAgY2hpbGRyZW46IFByb3BUeXBlcy5ub2RlLFxuICB0YWJJdGVtUmVuZGVyZXI6IFByb3BUeXBlcy5mdW5jLFxufTtcblxuLyoqXG4gKlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUYWJzIGV4dGVuZHMgQ29tcG9uZW50IHtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuc3RhdGUgPSB7fTtcbiAgICByZWdpc3RlclN0eWxlKCd0YWItbWVudScsIFtcbiAgICAgIFtcbiAgICAgICAgJy5zbGRzLXRhYnNfX2l0ZW0ucmVhY3Qtc2xkcy10YWItd2l0aC1tZW51JyxcbiAgICAgICAgJ3sgcG9zaXRpb246IHJlbGF0aXZlICFpbXBvcnRhbnQ7IG92ZXJmbG93OiB2aXNpYmxlICFpbXBvcnRhbnQ7IH0nLFxuICAgICAgXSxcbiAgICAgIFtcbiAgICAgICAgJy5zbGRzLXRhYnNfX2l0ZW0ucmVhY3Qtc2xkcy10YWItd2l0aC1tZW51ID4gLnJlYWN0LXNsZHMtdGFiLWl0ZW0tY29udGVudCcsXG4gICAgICAgICd7IG92ZXJmbG93OiBoaWRkZW4gfScsXG4gICAgICBdLFxuICAgICAgW1xuICAgICAgICAnLnNsZHMtdGFic19faXRlbS5yZWFjdC1zbGRzLXRhYi13aXRoLW1lbnUgPiAucmVhY3Qtc2xkcy10YWItaXRlbS1jb250ZW50ID4gYScsXG4gICAgICAgICd7IHBhZGRpbmctcmlnaHQ6IDJyZW07IH0nLFxuICAgICAgXSxcbiAgICAgIFtcbiAgICAgICAgJy5yZWFjdC1zbGRzLXRhYi1tZW51JyxcbiAgICAgICAgJ3sgcG9zaXRpb246IGFic29sdXRlOyB0b3A6IDA7IHJpZ2h0OiAwOyB2aXNpYmlsaXR5OiBoaWRkZW4gfScsXG4gICAgICBdLFxuICAgICAgW1xuICAgICAgICAnLnJlYWN0LXNsZHMtdGFiLW1lbnUgYnV0dG9uJyxcbiAgICAgICAgJ3sgaGVpZ2h0OiAyLjVyZW07IGxpbmUtaGVpZ2h0OiAycmVtOyB3aWR0aDogMnJlbTsgfScsXG4gICAgICBdLFxuICAgICAgW1xuICAgICAgICAnLnNsZHMtdGFic19faXRlbS5zbGRzLWFjdGl2ZSAucmVhY3Qtc2xkcy10YWItbWVudScsXG4gICAgICAgICcuc2xkcy10YWJzX19pdGVtOmhvdmVyIC5yZWFjdC1zbGRzLXRhYi1tZW51JyxcbiAgICAgICAgJ3sgdmlzaWJpbGl0eTogdmlzaWJsZSB9JyxcbiAgICAgIF0sXG4gICAgXSk7XG4gIH1cblxuICBjb21wb25lbnREaWRVcGRhdGUoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUuZm9jdXNUYWIpIHtcbiAgICAgIGNvbnN0IGVsID0gdGhpcy5hY3RpdmVUYWI7XG4gICAgICBpZiAoZWwpIHtcbiAgICAgICAgZWwuZm9jdXMoKTtcbiAgICAgIH1cbiAgICAgIC8qIGVzbGludC1kaXNhYmxlIHJlYWN0L25vLWRpZC11cGRhdGUtc2V0LXN0YXRlICovXG4gICAgICB0aGlzLnNldFN0YXRlKHsgZm9jdXNUYWI6IGZhbHNlIH0pO1xuICAgIH1cbiAgfVxuXG4gIG9uVGFiQ2xpY2sgPSAodGFiS2V5KSA9PiB7XG4gICAgaWYgKHRoaXMucHJvcHMub25TZWxlY3QpIHtcbiAgICAgIHRoaXMucHJvcHMub25TZWxlY3QodGFiS2V5KTtcbiAgICB9XG4gICAgLy8gVW5jb250cm9sbGVkXG4gICAgdGhpcy5zZXRTdGF0ZSh7IGFjdGl2ZUtleTogdGFiS2V5LCBmb2N1c1RhYjogdHJ1ZSB9KTtcbiAgfVxuXG4gIG9uVGFiS2V5RG93biA9ICh0YWJLZXksIGUpID0+IHtcbiAgICBpZiAoZS5rZXlDb2RlID09PSAzNyB8fCBlLmtleUNvZGUgPT09IDM5KSB7IC8vIGxlZnQvcmlnaHQgY3Vyc29yIGtleVxuICAgICAgbGV0IGlkeCA9IDA7XG4gICAgICBjb25zdCB0YWJLZXlzID0gW107XG4gICAgICBSZWFjdC5DaGlsZHJlbi5mb3JFYWNoKHRoaXMucHJvcHMuY2hpbGRyZW4sICh0YWIsIGkpID0+IHtcbiAgICAgICAgdGFiS2V5cy5wdXNoKHRhYi5wcm9wcy5ldmVudEtleSk7XG4gICAgICAgIGlmICh0YWJLZXkgPT09IHRhYi5wcm9wcy5ldmVudEtleSkge1xuICAgICAgICAgIGlkeCA9IGk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgY29uc3QgZGlyID0gZS5rZXlDb2RlID09PSAzNyA/IC0xIDogMTtcbiAgICAgIGNvbnN0IGFjdGl2ZUlkeCA9IChpZHggKyBkaXIgKyB0YWJLZXlzLmxlbmd0aCkgJSB0YWJLZXlzLmxlbmd0aDtcbiAgICAgIGNvbnN0IGFjdGl2ZUtleSA9IHRhYktleXNbYWN0aXZlSWR4XTtcbiAgICAgIHRoaXMub25UYWJDbGljayhhY3RpdmVLZXkpO1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBjbGFzc05hbWUsIGNoaWxkcmVuIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IHR5cGUgPSB0aGlzLnByb3BzLnR5cGUgPT09ICdzY29wZWQnID8gJ3Njb3BlZCcgOiAnZGVmYXVsdCc7XG4gICAgY29uc3QgdGFic0NsYXNzTmFtZXMgPSBjbGFzc25hbWVzKGNsYXNzTmFtZSwgYHNsZHMtdGFicy0tJHt0eXBlfWApO1xuICAgIGNvbnN0IGFjdGl2ZUtleSA9XG4gICAgICB0eXBlb2YgdGhpcy5wcm9wcy5hY3RpdmVLZXkgIT09ICd1bmRlZmluZWQnID8gdGhpcy5wcm9wcy5hY3RpdmVLZXkgOlxuICAgICAgdHlwZW9mIHRoaXMuc3RhdGUuYWN0aXZlS2V5ICE9PSAndW5kZWZpbmVkJyA/IHRoaXMuc3RhdGUuYWN0aXZlS2V5IDpcbiAgICAgIHRoaXMucHJvcHMuZGVmYXVsdEFjdGl2ZUtleTtcbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiBjbGFzc05hbWU9eyB0YWJzQ2xhc3NOYW1lcyB9PlxuICAgICAgICA8VGFiTmF2XG4gICAgICAgICAgdHlwZT17IHR5cGUgfVxuICAgICAgICAgIGFjdGl2ZUtleT17IGFjdGl2ZUtleSB9XG4gICAgICAgICAgYWN0aXZlVGFiUmVmPXsgKG5vZGUpID0+IHsgdGhpcy5hY3RpdmVUYWIgPSBub2RlOyB9IH1cbiAgICAgICAgICB0YWJzPXsgY2hpbGRyZW4gfVxuICAgICAgICAgIG9uVGFiQ2xpY2s9eyB0aGlzLm9uVGFiQ2xpY2sgfVxuICAgICAgICAgIG9uVGFiS2V5RG93bj17IHRoaXMub25UYWJLZXlEb3duIH1cbiAgICAgICAgLz5cbiAgICAgICAgeyBSZWFjdC5DaGlsZHJlbi5tYXAoY2hpbGRyZW4sIHRhYiA9PiBSZWFjdC5jbG9uZUVsZW1lbnQodGFiLCB7IGFjdGl2ZUtleSB9KSkgfVxuICAgICAgPC9kaXY+XG4gICAgKTtcbiAgfVxufVxuXG5jb25zdCBUQUJfVFlQRVMgPSBbJ2RlZmF1bHQnLCAnc2NvcGVkJ107XG5cblRhYnMucHJvcFR5cGVzID0ge1xuICBjbGFzc05hbWU6IFByb3BUeXBlcy5zdHJpbmcsXG4gIHR5cGU6IFByb3BUeXBlcy5vbmVPZihUQUJfVFlQRVMpLFxuICBvblNlbGVjdDogUHJvcFR5cGVzLmZ1bmMsXG4gIGNoaWxkcmVuOiBQcm9wVHlwZXMubm9kZSxcbiAgZGVmYXVsdEFjdGl2ZUtleTogUHJvcFR5cGVzLm9uZU9mVHlwZShbXG4gICAgUHJvcFR5cGVzLnN0cmluZyxcbiAgICBQcm9wVHlwZXMubnVtYmVyLFxuICBdKSxcbiAgYWN0aXZlS2V5OiBQcm9wVHlwZXMub25lT2ZUeXBlKFtcbiAgICBQcm9wVHlwZXMuc3RyaW5nLFxuICAgIFByb3BUeXBlcy5udW1iZXIsXG4gIF0pLFxufTtcbiJdfQ==